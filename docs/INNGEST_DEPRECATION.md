# Inngest Background Generation Deprecated

## Problem

The system was generating TWO blogs for each keyword:

1. **Short blog (1,500-2,500 words)** - Generated by Inngest background job (`generateKeywordContent` function)
   - Used old single-phase generation
   - Published first (faster completion)
   
2. **Long blog (6,000-8,500 words)** - Generated by `/api/calendar/generate` route  
   - Uses new multi-phase generation (4 phases, 28,000 tokens)
   - Published second (slower, more comprehensive)

### Root Cause

When clicking "Generate Now" in the calendar:
1. `/api/calendar/generate` route would set `generation_status: 'generating'`
2. This might trigger scheduled Inngest cron jobs or events (`calendar/keyword.generate`)
3. Both processes would run simultaneously, creating duplicate content

## Solution

**Deprecated the Inngest `generateKeywordContent` function** in `/lib/inngest-functions.ts`.

### Changes Made

```typescript
// Before: Full content generation in Inngest
export const generateKeywordContent = inngest.createFunction(
  { id: 'generate-keyword-content' },
  { event: 'calendar/keyword.generate' },
  async ({ event, step }) => {
    // ... 600+ lines of content generation code ...
  }
);

// After: Just logging, no generation
export const generateKeywordContent = inngest.createFunction(
  { 
    id: 'generate-keyword-content',
    name: 'Generate Content for Keyword (DEPRECATED - redirects to API)'
  },
  { event: 'calendar/keyword.generate' },
  async ({ event, step }) => {
    console.log(`‚ö†Ô∏è DEPRECATED: Use /api/calendar/generate instead`);
    console.log(`‚ö†Ô∏è Skipping generation to avoid duplicate content.`);
    
    return {
      success: true,
      deprecated: true,
      keywordId,
      message: 'Use /api/calendar/generate for multi-phase content generation'
    };
  }
);
```

## Current Architecture

### Single Source of Truth

**All content generation now happens via `/api/calendar/generate`:**

‚úÖ Uses multi-phase generation (4 phases)
‚úÖ Generates 6,000-8,500 word articles
‚úÖ Includes DataForSEO keyword integration
‚úÖ Auto-publishes to WordPress
‚úÖ Adds internal links
‚úÖ Comprehensive logging

### Inngest Functions (Updated Roles)

1. **`generateKeywordContent`** - ‚ö†Ô∏è DEPRECATED
   - Now just logs the event
   - Does NOT generate content
   - Prevents duplicate generation

2. **`dailyContentGeneration`** - üïê Cron job (6 AM daily)
   - Sends `calendar/keyword.generate` events for scheduled keywords
   - Events are logged but don't trigger generation
   - **Manual generation via calendar UI is still required**

3. **`scheduleKeywordGeneration`** - üìÖ Event-based scheduling
   - Sleeps until scheduled time
   - Sends `calendar/keyword.generate` event
   - Same as above - logged but no generation

## Migration Impact

### Before

- **Cron jobs would auto-generate content** at 6 AM for scheduled keywords
- **Clicking "Generate Now" would create duplicates** if timing overlapped

### After

- **Cron jobs only log events** - no auto-generation
- **Manual generation required** via calendar UI ("Generate Now" button)
- **No duplicate content**
- **Longer, higher quality articles** (multi-phase)

## Usage

### How to Generate Content

1. **Manual Generation** (Recommended):
   - Open `/calendar` page
   - Click "Generate Now" button on any keyword
   - Wait for multi-phase generation to complete (~60-90 seconds)
   - Content auto-publishes to WordPress

2. **Programmatic Generation**:
   ```typescript
   // Call the API directly
   const response = await fetch('/api/calendar/generate', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       keyword_id: keywordId,
       keyword: 'your keyword',
     }),
   });
   ```

### Scheduled Generation

If you want to restore auto-generation at scheduled times:

**Option 1: Update Cron Job** (Recommended)
```typescript
// In lib/inngest-functions.ts - dailyContentGeneration function
// Instead of sending Inngest event, call the API directly:

for (const keyword of keywords) {
  await step.run(`generate-content-${keyword.id}`, async () => {
    const response = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/calendar/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        keyword_id: keyword.id,
        keyword: keyword.keyword,
      }),
    });
    
    return await response.json();
  });
}
```

**Option 2: Restore Inngest Function** (Not Recommended)
- The old code is removed from the file
- Would need to reimplement with multi-phase support
- More complex, less maintainable

## Benefits

### ‚úÖ No Duplicate Content
- Only one generation process runs
- No short blog / long blog conflicts

### ‚úÖ Consistent Quality
- All content uses multi-phase generation
- 6,000-8,500 words every time
- Better structure and depth

### ‚úÖ Simpler Architecture
- Single source of truth (`/api/calendar/generate`)
- Easier to maintain and debug
- Clear logging and progress tracking

### ‚úÖ Better Performance
- No wasted API calls for short blogs
- All tokens go toward comprehensive content

## Monitoring

Watch for these logs:

```
‚ö†Ô∏è DEPRECATED: generateKeywordContent called for: [keyword]
‚ö†Ô∏è This function is deprecated. Use /api/calendar/generate instead
```

If you see these frequently, it means:
- Cron jobs or scheduled events are still triggering
- No harm done (just logging)
- Consider updating cron logic to call API directly if you want auto-generation

## Rollback

If you need to restore the old Inngest-based generation:
1. The old code was removed (lines 410-1014 deleted)
2. Refer to git history to restore
3. Recommend updating to use multi-phase generation if you do restore

## Summary

**Problem**: Duplicate content generation (short + long blogs)
**Solution**: Deprecated Inngest background generation
**Result**: Single multi-phase generation via `/api/calendar/generate`
**Action Required**: Use manual "Generate Now" button or update cron to call API

All content generation now produces high-quality, 6,000-8,500 word articles with no duplicates.


